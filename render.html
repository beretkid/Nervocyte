<script type="importmap">
  {
    "imports": {
        "three": "https://unpkg.com/three/build/three.module.js",
      "three/addons/": "https://unpkg.com/three/examples/jsm/"
    }
  }
</script>

<script type="module" id="renderer">
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import * as THREE from 'three';
  import { STLLoader } from 'three/addons/loaders/STLLoader.js'; 

  // --- Initializing Variables (Standardized to Radians/Defaults) ---
  var i = 0
  var pct = 0
  var camturn = 0
  // Initialize camera orientation variables in RADIANS
  var camup = 0;   
  var camright = 0; 
  // Define a consistent rotation speed in RADIANS (approx 2 degrees per update)
  const rotationSpeed = Math.PI / 180 * 2; 

  const canvas = document.getElementById('visuals');
  const ctx = canvas.getContext("2d");
  const hphs = document.getElementById("hphs")
  var pressedKeys = []
     const textureLoader = new THREE.TextureLoader();

  window.addEventListener('message', (event) => {
    pressedKeys = event.data.pressedKeys
  })

  canvas.width = window.innerWidth * 1
  canvas.height = window.innerHeight * 1
  var w = canvas.width;
  var h = canvas.height;

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
  // CRITICAL FIX: Set Euler order to YXZ for proper FPS controls once at setup

    var upVector = new THREE.Vector3(0, 1, 0); // Fuck whoops that was a const
  // Define the X-axis vector globally once (for movement calculations if needed later)
  var sideVector = new THREE.Vector3(1, 0, 0);
  const renderer = new THREE.WebGLRenderer();
  renderer.setSize( window.innerWidth, window.innerHeight );
  renderer.domElement.id = "wawa"
  document.body.appendChild( renderer.domElement );

  var light = new THREE.AmbientLight( 0x404040 ); 
  scene.add( light );
  const entities = []
  const geometry2 = new THREE.BoxGeometry( 1000, 1000, 1 );
  const material2 = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );

  // The degToRad function is no longer needed if we use radians everywhere
  /* function degToRad(degrees) {
    return degrees * (Math.PI / 180);
  } */
  //load textures
    const texture = textureLoader.load('Assets/TerrainTexture.png');
    const groundtex = new THREE.MeshStandardMaterial({
        map: texture
    });
  const floor = new THREE.Mesh(geometry2, material2);
  scene.add(floor);
  floor.position.set(0, 0, 0); // Cleaner way to set position

  const loader = new STLLoader();

  loader.load(
    'Assets/CitidelWall.stl', 
    function (geometry) {
        const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        const cube = new THREE.Mesh(geometry, groundtex);
        scene.add(cube);
        console.log('Model loaded successfully!');
        renderer.setAnimationLoop( animate );
        cube.position.y = 5
        camera.position.z = 4;
       camera.rotation.x = Math.PI / 2; // 1.5708 radians
    },
    undefined, 
    function (error) {
        console.error('An error occurred while loading the model:', error);
    }
  );
    
  var wdown = false
  var adown = false
  var sdown = false
  var ddown = false

  function animate() {
    var curr
    var cpx = camera.position.x
    var cpy = camera.position.z

    ctx.clearRect(0,0,1000,1000)
    for (i in entities) {
      ctx.fillStyle = "White"
      curr = entities[i]
      ctx.fillRect(curr.x + cpx,curr.y + cpy * 100,10,10)
      
    }
    
    //upVector = new THREE.Vector3(0, camright, 0);
     
    if (pressedKeys["ArrowLeft"]) { 
      // Rotate around the world's UP axis (Y axis) relative to current orientation
      
      camera.rotateOnAxis(upVector, rotationSpeed); 
      camright += rotationSpeed
    }
    if (pressedKeys["ArrowRight"]) { 
       // Rotate the other way
     
      camera.rotateOnAxis(upVector, -rotationSpeed); 
       camright += -rotationSpeed
    }
  
    




    
    renderer.render( scene, camera );

    const moveSpeed = 0.05;

    if (pressedKeys["KeyS"]) {
      // Moves backward along the camera's local Z-axis
      camera.translateZ(moveSpeed); 
    }
    if (pressedKeys["KeyW"]) {
      // Moves forward along the camera's local Z-axis
      camera.translateZ(-moveSpeed); 
    }
    if (pressedKeys["KeyA"]) {
      // Moves left along the camera's local X-axis
      camera.translateX(-moveSpeed);
    }
    if (pressedKeys["KeyD"]) {
      // Moves right along the camera's local X-axis
      camera.translateX(moveSpeed);
    }



  }

  var changex = 0
  var changey = 0
  var prevx = 0
  var prevy = 0 

  ctx.fillStyle = "red"
  ctx.fillRect(0,0,50,50)

</script>

<canvas id="visuals" width="100" height="100" style="z-index: 01;position:absolute;top:0%;left:0%;border:2px solid;border-color:#0f0f0f"></canvas>

<style>
#wawa {
  position: absolute;
  top: 0%;
  left: 0%;
  font-size: 28px;
  font-family: monospace;
}
</style>
